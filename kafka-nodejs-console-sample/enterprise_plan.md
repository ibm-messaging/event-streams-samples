# IBM Message Hub Kafka Node.js console sample application: Enterprise Plan deployment into IBM Cloud

## Prerequisites (IBM Cloud速)
* [Cloud Foundry Command Line Interface](https://github.com/cloudfoundry/cli/releases) installed

## Overview
To deploy and run the sample:
* Create a Cloud Foundry Service Alias for your Enterprise Service
* Setup your `manifest.yml` with your service details
* Use `ibmcloud cf push --no-start` to deploy the app to IBM Cloud速
* Re-configure binding with Manager role
* Start the app
* View the application's logs

## Set up a Cloud Foundry Service Alias
Before continuing, connect to IBM Cloud with the [IBM Cloud command line interface](https://console.bluemix.net/docs/cli/reference/bluemix_cli/get_started.html#getting-started).

The Enterprise plan is IAM enabled. Therefore the following extra step is required to create a Cloud Foundry alias for your Service:

Create a Cloud Foundry alias for your service's associated CRN:
```shell
ibmcloud resource service-alias-create <messagehub-service-name> --instance-name <messagehub-service-name>
```

Having created this alias associated your Service with a Cloud Foundry Organization and Space, thereby enabling your Cloud Foundry application to referrence it and connect to it.


## Setup the manifest.yml
Open the `manifest.yml` file and rename the `"Message Hub-CHANGEME"` entry to that of your own Message Hub Service Instance *Alias* name:

```
  services:
    - "<your service alias name here>"
```

Optionally rename the service:

```
- name: kafka-nodejs-console-sample
```

## Push the application into IBM Cloud速
Connect to IBM Cloud速 with the Cloud Foundry Command Line Interface, then run the following command in the same directory as the `manifest.yml` file:
```shell
ibmcloud cf push --no-start
```

This will push your application but will not start it just yet. We'll need to re-configure the security settings such that the application is allowed to create topics:

## Re-configure the binding
The NodeJS build pack tries to be helpful by auto-creating a binding in between the Cloud Foundry Service Alias and the application pushed. This is however with a role that doesn't allow topic creation within Message Hub. As such, we need to re-bind the app:

```
ibmcloud resource service-binding-delete <YOUR_SERVICE_INSTANCE_ALIAS_NAME> <YOUR APPLICATION'S NAME>
ibmcloud resource service-binding-create <YOUR_SERVICE_INSTANCE_ALIAS_NAME> <YOUR APPLICATION'S NAME> Manager
```

## Start the app
Now it should be safe to start the application:
```
ibmcloud app start <YOUR APPLICATION'S NAME>
```

## Inspect the app's logs
You can optionally inspect the app's logs (The app only logs when the UI button gets hit):
```
ibmcloud app logs <YOUR APPLICATION'S NAME>
```

## Sample Output
Below is a snippet of the output generated by the sample:

```
Topic mh-nodejs-console-sample-topic created
Existing topics:
[ { name: 'mh-nodejs-console-sample-topic',
    partitions: 1,
    retentionMs: '86400000',
    markedForDeletion: false } ]
The consumer has started
The producer has started
Topic object created with opts {"request.required.acks":-1}
Consumer obtained metadata: {"orig_broker_id":0,"orig_broker_name":"sasl_ssl://kafka01-prod01.messagehub.services.us-south.bluemix.net:9093/0","topics":[{"name":"mh-nodejs-console-sample-topic","partitions":[{"id":0,"leader":0,"replicas":[0,1,4],"isrs":[null,null,null,1]}]}],"brokers":[{"id":2,"host":"kafka03-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":4,"host":"kafka05-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":1,"host":"kafka02-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":3,"host":"kafka04-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":0,"host":"kafka01-prod01.messagehub.services.us-south.bluemix.net","port":9093}]}
Producer obtained metadata: {"orig_broker_id":0,"orig_broker_name":"sasl_ssl://kafka01-prod01.messagehub.services.us-south.bluemix.net:9093/0","topics":[{"name":"mh-nodejs-console-sample-topic","partitions":[{"id":0,"leader":0,"replicas":[0,1,4],"isrs":[null,null,null,1]}]}],"brokers":[{"id":2,"host":"kafka03-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":4,"host":"kafka05-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":1,"host":"kafka02-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":3,"host":"kafka04-prod01.messagehub.services.us-south.bluemix.net","port":9093},{"id":0,"host":"kafka01-prod01.messagehub.services.us-south.bluemix.net","port":9093}]}
Message produced, offset: 1
No messages consumed
Message produced, offset: 2
Message consumed: topic=mh-nodejs-console-sample-topic, partition=0, offset=1, key=key, value=This is a test message #1
Message produced, offset: 3
Message consumed: topic=mh-nodejs-console-sample-topic, partition=0, offset=2, key=key, value=This is a test message #2
Message produced, offset: 4
Message consumed: topic=mh-nodejs-console-sample-topic, partition=0, offset=3, key=key, value=This is a test message #3
```

## Further references

If you are unfamiliar with Cloud Foundry applications or Liberty then you might find the following documents useful:

[Cloud Foundry manifest documentation](http://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html)
